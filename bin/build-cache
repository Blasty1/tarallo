#!/usr/bin/php
<?php

namespace WEEEOpen\Tarallo;

use WEEEOpen\Tarallo\SSRv1\Controller;
use Zend\Diactoros\ServerRequestFactory;

require __DIR__ . DIRECTORY_SEPARATOR . '..' . DIRECTORY_SEPARATOR . 'vendor' . DIRECTORY_SEPARATOR . 'autoload.php';

if($argc > 1) {
	$prefix = rtrim($argv[1], '\/') . DIRECTORY_SEPARATOR;
	foreach([$prefix, $prefix . 'SSRv1/', $prefix . 'APIv1/'] as $dir) {
		if(!is_dir($dir)) {
			echo "$dir is not a directory";
			exit(1);
		}
	}
} else {
	$prefix = '';
}

define('CACHE_ENABLED', true);
mkdir('../resources/cache/', true);
$handle = new \ReflectionMethod(SSRv1\Controller::class, 'handle');
$handle->setAccessible(true);
$handle->invoke(new SSRv1\Controller(), ServerRequestFactory::fromGlobals([], [], [], [], []));

APIv2\Controller::getDispatcher($prefix . 'APIv1/router.cache');
